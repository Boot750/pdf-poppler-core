name: CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  test:
    name: Test on ${{ matrix.os }} with Node.js ${{ matrix.node-version }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest] # windows-latest, macos-latest]
        node-version: [16, 18, 20]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Setup virtual display for graphics tests (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb

    - name: Verify binary files exist (Linux)
      run: |
        echo "Linux platform detected"
        ls -la lib/linux/ || echo "Linux lib directory not found"
        ls -la lib/linux/poppler-latest/bin/ || echo "Linux binaries not found"
        ls -la lib/linux/poppler-latest/lib/ || echo "Linux libraries not found"

    - name: Setup Linux binaries
      run: |
        chmod +x lib/linux/poppler-latest/bin/* || echo "Failed to make Linux binaries executable"

    - name: Test binary execution (Linux)
      run: |
        echo "Testing Linux binaries..."
        ./lib/linux/poppler-latest/bin/pdfinfo -v || echo "pdfinfo version check failed"

    - name: Run tests
      run: |
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          xvfb-run -a npm test
        else
          npm test
        fi
      env:
        CI: true

    - name: Test with sample PDF
      run: |
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          xvfb-run -a node -e "
          const poppler = require('./index.js');
          console.log('Platform:', process.platform);
          console.log('Poppler path:', poppler.path);

          (async () => {
            try {
              const info = await poppler.info('sample.pdf');
              console.log('PDF Info test passed - Pages:', info.pages);

              const imageData = await poppler.imgdata('sample.pdf');
              console.log('Image data test passed - Found', imageData.length, 'images');

              console.log('All basic functionality tests passed!');
            } catch (error) {
              console.error('Functionality test failed:', error.message);
              process.exit(1);
            }
          })();
          "
        else
          node -e "
          const poppler = require('./index.js');
          console.log('Platform:', process.platform);
          console.log('Poppler path:', poppler.path);

          (async () => {
            try {
              const info = await poppler.info('sample.pdf');
              console.log('PDF Info test passed - Pages:', info.pages);

              const imageData = await poppler.imgdata('sample.pdf');
              console.log('Image data test passed - Found', imageData.length, 'images');

              console.log('All basic functionality tests passed!');
            } catch (error) {
              console.error('Functionality test failed:', error.message);
              process.exit(1);
            }
          })();
          "
        fi

    - name: Upload test artifacts
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-output-${{ matrix.os }}-node${{ matrix.node-version }}
        path: |
          test-output/
          *.png
          *.jpg
          *.jpeg
        retention-days: 7