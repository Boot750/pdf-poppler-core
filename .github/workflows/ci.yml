name: CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  test:
    name: Test on ${{ matrix.os }} with Node.js ${{ matrix.node-version }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        node-version: [18, 20, 22, 24]
        include:
          - os: ubuntu-latest
            binary_package: pdf-poppler-binaries-linux
            binary_path: packages/pdf-poppler-binaries-linux/lib/linux
          - os: windows-latest
            binary_package: pdf-poppler-binaries-win32
            binary_path: packages/pdf-poppler-binaries-win32/lib/win

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci --legacy-peer-deps

    - name: Build and install local packages for testing
      shell: bash
      run: |
        cd packages/pdf-poppler-core && npm install && npm run build && cd ../..
        npm install ./packages/pdf-poppler-core ./packages/${{ matrix.binary_package }} --legacy-peer-deps

    - name: Setup virtual display (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb

    - name: Setup platform binaries (Linux/macOS)
      if: matrix.os != 'windows-latest'
      shell: bash
      run: |
        find ${{ matrix.binary_path }} -type d -name "bin" -exec chmod -R +x {} \;

    - name: Test binary execution
      shell: bash
      run: |
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          POPPLER_DIR=$(ls -d ${{ matrix.binary_path }}/poppler-*-xvfb 2>/dev/null | head -1 || echo "${{ matrix.binary_path }}/poppler-xvfb-latest")
          export LD_LIBRARY_PATH="$POPPLER_DIR/lib:$LD_LIBRARY_PATH"
          ${POPPLER_DIR}/bin/pdfinfo -v || echo "pdfinfo version check failed"
        elif [ "${{ matrix.os }}" = "windows-latest" ]; then
          POPPLER_DIR=$(ls -d ${{ matrix.binary_path }}/poppler-[0-9]* 2>/dev/null | sort -V | tail -1 || echo "${{ matrix.binary_path }}/poppler-0.51")
          ${POPPLER_DIR}/bin/pdfinfo.exe -v || echo "pdfinfo version check failed"
        fi

    - name: Run tests
      shell: bash
      run: |
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          xvfb-run -a npm test -- --runInBand
        else
          npm test -- --runInBand
        fi
      env:
        CI: true

    - name: Test with sample PDF
      shell: bash
      run: |
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          xvfb-run -a node -e "
          const poppler = require('pdf-poppler-core');
          (async () => {
            const info = await poppler.info('sample.pdf');
            console.log('PDF Info test passed - Pages:', info.pages);
          })();
          "
        else
          node -e "
          const poppler = require('pdf-poppler-core');
          (async () => {
            const info = await poppler.info('sample.pdf');
            console.log('PDF Info test passed - Pages:', info.pages);
          })();
          "
        fi

  # Test AWS Lambda compatibility (Amazon Linux 2 container)
  test-lambda:
    name: Test Lambda (Amazon Linux 2) Node ${{ matrix.node-version }}
    runs-on: ubuntu-latest
    container:
      image: amazonlinux:2

    strategy:
      fail-fast: false
      matrix:
        node-version: [18, 20]

    steps:
    - name: Install system dependencies
      run: |
        yum update -y
        yum install -y git tar gzip xz

    - name: Install Node.js ${{ matrix.node-version }}
      run: |
        curl -fsSL https://rpm.nodesource.com/setup_${{ matrix.node-version }}.x | bash -
        yum install -y nodejs

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install npm dependencies
      run: npm ci --legacy-peer-deps

    - name: Build and install packages
      run: |
        cd packages/pdf-poppler-core && npm install && npm run build && cd ../..
        npm install ./packages/pdf-poppler-core ./packages/pdf-poppler-binaries-aws-2 --legacy-peer-deps

    - name: Setup binaries
      run: |
        find packages/pdf-poppler-binaries-aws-2/lib/aws-2 -type d -name "bin" -exec chmod -R +x {} \;

    - name: Test binary execution
      run: |
        POPPLER_DIR=$(ls -d packages/pdf-poppler-binaries-aws-2/lib/aws-2/poppler-*-xvfb 2>/dev/null | head -1)
        export LD_LIBRARY_PATH="$POPPLER_DIR/lib:$LD_LIBRARY_PATH"
        ${POPPLER_DIR}/bin/pdfinfo -v
        echo "Lambda binary test passed!"

    - name: Test PDF operations
      run: |
        node -e "
        const poppler = require('pdf-poppler-core');
        console.log('Poppler path:', poppler.path);
        (async () => {
          const info = await poppler.info('sample.pdf');
          console.log('PDF Info test passed - Pages:', info.pages);
          console.log('Lambda compatibility test passed!');
        })();
        "
